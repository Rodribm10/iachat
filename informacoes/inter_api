# Documenta√ß√£o T√©cnica: Integra√ß√£o Banco Inter API (Pix V2)

Esta documenta√ß√£o descreve a integra√ß√£o com a API de Parceiros do Banco Inter (CDPJ) para processamento de pagamentos via Pix, implementada no ecossistema Captain/Chatwoot.

## üîë Autentica√ß√£o e Seguran√ßa

A API do Banco Inter utiliza um modelo de seguran√ßa robusto baseado em **Mutual TLS (mTLS)** e **OAuth2**.

- **Protocolo**: HTTPS com Certificado Digital (Chave P√∫blica e Privada).
- **OAuth2 Flow**: `client_credentials`.
- **Scopes Utilizados**: `cob.write`, `cob.read`, `webhook.write`, `webhook.read`, `extrato.read`.
- **Headers Mandat√≥rios**:
  - `x-conta-corrente`: N√∫mero da conta corrente do parceiro.
  - `Authorization`: Token Bearer obtido via OAuth2.

### Credenciais
As credenciais s√£o configuradas por Unidade (`Captain::Unit`) e incluem:
- `client_id` / `client_secret`
- `inter_cert_path` e `inter_key_path` (Caminhos para arquivos `.pem`)
- `inter_pix_key` (Chave Pix CPF/CNPJ/E-mail/EVP)

---

## üöÄ Fluxo de Cobran√ßa Pix (Cobran√ßa Imediata)

O sistema utiliza o endpoint de **Cobran√ßa Imediata (Cob)** para gerar faturas Pix para reservas.

### 1. Gera√ß√£o da Cobran√ßa
**Endpoint**: `POST https://cdpj.partners.bancointer.com.br/pix/v2/cob`  
**Servi√ßos Locais**: `Captain::Inter::CobService` e `Captain::InterService`.

**Payload Exemplo**:
```json
{
  "calendario": { "expiracao": 3600 },
  "devedor": {
    "cpf": "12345678900",
    "nome": "Nome do Cliente"
  },
  "valor": { "original": "150.00" },
  "chave": "sua-chave-pix@email.com",
  "solicitacaoPagador": "Reserva #12345"
}
```

### 2. Pix One-Tap (Link Seguro)
Para melhorar a UX no WhatsApp, foi implementado o fluxo **One-Tap**:
- Em vez de enviar o c√≥digo bruto (geralmente muito longo), o bot envia um link curto: `https://seu-dominio/r/:token`.
- O `:token` √© um **SGID (Signed Global ID)** com expira√ß√£o de 2 horas.
- Ao abrir o link, o cliente v√™ uma p√°gina otimizada com o bot√£o "Copiar Pix" e feedback visual.

---

## üîó Webhooks e Confirma√ß√£o

O Banco Inter notifica o sistema sobre o pagamento atrav√©s de webhooks.

- **Endpoint**: `POST /public/api/v1/captain/inter_webhooks`
- **Controller**: `Public::Api::V1::Captain::InterWebhooksController`

**Processamento**:
1. Extra√ß√£o do `txid` (Transaction ID) e `endToEndId` (Identificador E2E do Banco Central).
2. Verifica√ß√£o de idempot√™ncia (evita processar o mesmo pagamento duas vezes).
3. Atualiza√ß√£o do status da `Captain::PixCharge` para `paid`.
4. Disparo do `Captain::Payments::ConfirmationService` para validar a reserva.
5. Mensagem autom√°tica enviada via Chatwoot confirmando o pagamento para o cliente.

---

## üõ†Ô∏è Modelos de Dados Principais

### `Captain::PixCharge`
- Atributos: `txid`, `e2eid`, `status` (active, paid, expired, failed), `pix_copia_e_cola`.
- Rela√ß√µes: `belongs_to :reservation`, `belongs_to :unit`.

---

## üìÇ Localiza√ß√£o dos Arquivos

| Componente | Caminho |
| :--- | :--- |
| **Service Principal** | `app/services/captain/inter_service.rb` |
| **Service Enterprise** | `enterprise/app/services/captain/inter/cob_service.rb` |
| **Controller Webhook** | `app/controllers/public/api/v1/captain/inter_webhooks_controller.rb` |
| **Model** | `enterprise/app/models/captain/pix_charge.rb` |
| **P√°gina de Pagamento** | `app/views/public/api/v1/captain/payments/show.html.erb` |

---

## üìù Notas de Manuten√ß√£o (Ressalvas)
- **Encoding**: Foi corrigido um bug cr√≠tico onde a API do Inter retornava caracteres em encoding bin√°rio que causavam falha no Rails ao renderizar JSON. Sempre use `.force_encoding('UTF-8')` ao lidar com a resposta da API do Inter.
- **Ambiente de Dev**: No ambiente de desenvolvimento local, o sistema sanitiza URLs de `0.0.0.0` para `127.0.0.1` para garantir que o link One-Tap seja acess√≠vel localmente.

---
*Documenta√ß√£o gerada em 23/02/2026 baseada na an√°lise t√©cnica do reposit√≥rio local devido √† instabilidade do Notion.*
